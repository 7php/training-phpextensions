# About

- this repo is based on the tutorial of SaraMG who is currently my mentor for "how to create PHP Extension from Scratch"
- Her repo: https://github.com/sgolemon/2016-sfmeetup

## This Commit Layer

- Hash: 6a4bd97 Bare Minimum

## Key points

### Building an extension

Run `phpize` from the code directory to generate the `./configure` script, you'll see output similar to the following:

```
Configuring for:
PHP Api Version:         20170718
Zend Module Api No:      20170718
Zend Extension Api No:   320170718
```

These numbers indicate (roughly) the PHP version.  Specifically:

#### PHP Api Version

This comes from the constant `PHP_API_VERSION` defined in [main/php.h](https://github.com/php/php-src/blob/df4edde870ef42fdd8397f9d67c6c9b5d9b74bac/main/php.h#L29). Changes in this number indicate a change in C APIs exported by the "php" half of php-src (ext, main, and sapi directories).

#### Zend Module Api No

This comes from the constant `ZEND_MODULE_API` defined in [Zend/zend\_modules.h](https://github.com/php/php-src/blob/df4edde870ef42fdd8397f9d67c6c9b5d9b74bac/Zend/zend_modules.h#L36). Changes in this number indicate a change in C APIs exported by the "Zend" half of php-src (Zend and TSRM directories)

#### Zend Extension Api No

This comes from the constant `ZEND_EXTENSION_API_NO` defined in [Zend/zend\_extensions.h](https://github.com/php/php-src/blob/df4edde870ef42fdd8397f9d67c6c9b5d9b74bac/Zend/zend_extensions.h#L49). Changes in this number indicate a change in the core scripting engine API and the hooks related to "zend extensions".  These are NOT the same thing as PHP extensons (which this exercise focuses on) and are usually safe to ignore until you're much deeper into the weeds.

### Configure the build

Run `./configure`, again from the code checkout, to generate the `Makefile`.  The output of this command is much longer, and should end with something like:

```
configure: creating ./config.status
config.status: creating config.h
```
### Build the extension

Run `make` from the same directory to compile the extension defined by the config.m4 file.  Your output will be verbose, but if all goes well, you'll see something like:

```
----------------------------------------------------------------------
Libraries have been installed in:
  $PWD/modules
.
.
.
Build complete.
Don't forget to run 'make test'.
```

This tells you that the extension was compiled, and the dynamic library can be found in the `modules/` directory.

## Try the extension out

From here the extension can be loaded via INI setting directly from the command line, along with any normal PHP invocation such as `-m` to list the loaded modules and see that it exists, `--re $EXTNAME` to view reflection info, or `-r 'hello();` to execute script code.

```
$ php -d extension=$PWD/modules/hello.so -m
$ php -d extension=$PWD/modules/hello.so --re hello
$ php -d extension=$PWD/modules/hello.so -r 'hello();' # This will fail, as we haven't defined the function yet.
```

## My Questions

1. Is there any particular reason why use `if test "$PHP_HELLO" != "no"; then` over `if test "$PHP_HELLO" = "yes"; then` ?
    - `$PHP_HELLO` will only be `yes` if no argument is passed (e.g. --enable-hello vs --enable-hello=hiya)  In that latter case `$PHP_HELLO = "hiya"`.  By using `!= "no"` we capture both eith and without argument cases.
2. Can you tell me more about the variable `$PHP_HELLO` - where does it come from & how it's managed by the PHP Core..etc?
    - It's generated by the `PHP_ARG_WITH()` macro. "hello" comes from the extension name given in the first argument.  The second argument is displayed in `./configure --help` output.  By convention, `PHP_ARG_ENABLE` is used for extensions which do NOT depend on an external library, while `PHP_ARG_WITH()` is normally used for extensions which do depend on external libs.  In this case, we're not depending on an external library YET, but in later commits we will be.
    - Both macros are defined in `php-src:/acinclude.m4`.
3. What are the values that are contained in `$ext_shared` (used in config.m4) & where do these come from. (from acinclude.m4, I see the definition below)
4. Where (in which file) is the function `zend_module_entry` defined?
    - Regarding the explanation of this method itself, this has been covered in **MyFirstSteps/02/readme.md** by Sara.
    

## My Observations

- The definition of `PHP_ARG_ENABLE` in `/usr/lib/php/20151012/build/acinclude.m4` (php-src) is:
    > `PHP_ARG_ENABLE(arg-name, check message, help text[, default-val[, extension-or-not]])`
    
- The definition of `PHP_ARG_WITH` in `/usr/lib/php/20151012/build/acinclude.m4` (php-src) is:
    > `PHP_ARG_WITH(arg-name, check message, help text[, default-val[, extension-or-not]])`
    
- `dnl` (in config.m4), is a built-in function, which stands for **delete to new line** reads and discards all characters up to and including the next newline.

- The definition of `PHP_NEW_EXTENSION.` in `/usr/lib/php/20151012/build/acinclude.m4` (php-src) is:
    > `PHP_NEW_EXTENSION(extname, sources [, shared [, sapi_class [, extra-cflags [, cxx [, zend_ext]]]]])`
    
- STEPS to **Build The Extension** (assuming we are in our current custom extension directory)
    ```
    $ phpize
    $ ./configure
    $ make
    ```

- OUTPUT when I executed `$ php -d extension=$PWD/modules/hello.so --re hello`
    > Extension [ <persistent> extension #70 hello version <no_version> ] {
    >  }
    
- OUTPUT when I executed `$ php -d extension=$PWD/modules/hello.so -r 'hello();'`
    > PHP Fatal error:  Uncaught Error: Call to undefined function hello() in Command line code:1
    >  Stack trace:
    >  #0 {main}
    >    thrown in Command line code on line 1
    
    
    
# Total Repo Objectives

```
* ae91dd4 (HEAD, origin/master, origin/HEAD, master) Teach Hello\Curl to do something useful
* bb1c920 Give Hello\Curl some custom storage
* 965f28c Add Hello\Curl class skeleton
* 4b0bcb4 Declare HELLO_CURL constnat
* 75d9042 Detect libcurl and link if available
* fcd7760 Add a function returning an array
* de1578f Take multiple args, iterate an array
* 5ff9cd7 Accept a string
* 9ed889a Return some values
* f7a842b Add hello_world() function
* 6a4bd97 Bare Minimum
```
